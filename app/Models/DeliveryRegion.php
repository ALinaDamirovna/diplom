<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class DeliveryRegion extends Model
{

    use HasFactory;

    static function getZones()
    {
        $config = Setting::where('module', 'delivery')->pluck('value', 'setting')->toArray();

        return [
            1 => [
                'name' => '1 зона',
                'price' => (int) $config['price_1'],
                'free_from' => (int) $config['free_1'],
                'points' => [
                    [53.31083177458623,56.89998320128224],
                    [53.228292399571366,56.88559945899531],
                    [53.224632923656586,56.880968254551114],
                    [53.21645566494228,56.88235632004725],
                    [53.21400571904686,56.881804828000725],
                    [53.21018248213576,56.88185552685974],
                    [53.20910582725596,56.881248368853704],
                    [53.2047992077367,56.88122314716632],
                    [53.202022455514566,56.88421910577171],
                    [53.188746529049475,56.88576492777065],
                    [53.182966872701684,56.887101612554865],
                    [53.18024870590474,56.886360451596396],
                    [53.1794046066371,56.88533208093718],
                    [53.17976213700825,56.884303681880326],
                    [53.16991943808223,56.87659242670002],
                    [53.15063536342381,56.87282785199494],
                    [53.151414026882804,56.8647070802193],
                    [53.155064924774386,56.86149231212415],
                    [53.16043243643559,56.85940570981773],
                    [53.166875925334026,56.85720706914435],
                    [53.176620802107465,56.85704812661512],
                    [53.18600930706741,56.858371968531934],
                    [53.18853135694924,56.85800309899488],
                    [53.191396729584966,56.85754018569994],
                    [53.19460542497469,56.85444401483129],
                    [53.195017969842226,56.849583048684856],
                    [53.196374652283076,56.8448155209682],
                    [53.195216584724534,56.84434699076847],
                    [53.189210236766726,56.844397696321174],
                    [53.1870947023645,56.84562796766451],
                    [53.17981370224825,56.84660684997449],
                    [53.17754128112711,56.84762389692261],
                    [53.176672874275525,56.84770610919265],
                    [53.17581127404504,56.847588338259584],
                    [53.17480892137761,56.84718817954173],
                    [53.1736098718968,56.846458400423344],
                    [53.17307938112784,56.84645688474903],
                    [53.171243426685,56.845865922543084],
                    [53.17074492010739,56.84546006140465],
                    [53.17082368287473,56.845248034831116],
                    [53.171266491450474,56.84498860423476],
                    [53.17092547261533,56.844657883555335],
                    [53.17061042036518,56.84481957527659],
                    [53.17008566887493,56.84481370489952],
                    [53.16858646797436,56.84421400723226],
                    [53.168282937987534,56.84369663405504],
                    [53.16724965765442,56.84376726350184],
                    [53.166520874503924,56.84377549401189],
                    [53.165877922041894,56.84366613068293],
                    [53.165621985379616,56.84384722299196],
                    [53.16475969357859,56.84378607017919],
                    [53.1642407245315,56.84393658561383],
                    [53.163491699874584,56.843927161547114],
                    [53.16312623275421,56.843720163693995],
                    [53.16155835642604,56.843611910735596],
                    [53.16112767397333,56.843889299148394],
                    [53.16082338737265,56.84383258853235],
                    [53.16026024568524,56.84371916704143],
                    [53.15983597424419,56.84396269840002],
                    [53.15944510276837,56.84388531255615],
                    [53.15815504293002,56.84289561479863],
                    [53.1589367881204,56.83534135523897],
                    [53.16222218556657,56.835451371598765],
                    [53.1625828057756,56.83195444970071],
                    [53.16634482864024,56.83211224107657],
                    [53.172777817848505,56.83129856168484],
                    [53.181073422925216,56.83162389227823],
                    [53.19374659368885,56.832321596901856],
                    [53.19833034560524,56.833011207808504],
                    [53.19975595257803,56.823991042569624],
                    [53.19888121450921,56.823502816467546],
                    [53.198059450262306,56.82290285746934],
                    [53.19792807277481,56.822455948094984],
                    [53.20388689643221,56.81334317395463],
                    [53.21801854419972,56.811861368710545],
                    [53.21776459348841,56.812682058659],
                    [53.21451011003449,56.81704775199254],
                    [53.21645546594154,56.81717991210272],
                    [53.2167700387676,56.817502990816976],
                    [53.217427934347505,56.81759071494237],
                    [53.21937287115943,56.81761426173158],
                    [53.220180551349046,56.81745989622328],
                    [53.22064490878478,56.817587954239464],
                    [53.221772777675525,56.817206089851744],
                    [53.22487475240126,56.817106065953915],
                    [53.23196785414113,56.8185122913157],
                    [53.2332392212142,56.81845435618881],
                    [53.239000606178216,56.81875803768431],
                    [53.24005203211205,56.81910895597814],
                    [53.24069576227562,56.818295146497405],
                    [53.25680983679511,56.82105034545202],
                    [53.259770676926564,56.82113321103125],
                    [53.27082121875744,56.82301017217786],
                    [53.27694730449222,56.82321914161741],
                    [53.27895351718013,56.8243222989707],
                    [53.28187112334638,56.82480100435221],
                    [53.284102402625784,56.825205068270904],
                    [53.28418791469331,56.82551500691869],
                    [53.28500330623394,56.82558559761538],
                    [53.28641951259392,56.82683267803439],
                    [53.286076189839825,56.826515029401925],
                    [53.2853895443323,56.82600913902115],
                    [53.28688085254445,56.82715620621566],
                    [53.28731000598676,56.82736796861152],
                    [53.28731000598681,56.82736796861165],
                    [53.28770697292112,56.82752090735702],
                    [53.28797519382326,56.82760914144783],
                    [53.28805029567573,56.82765031704855],
                    [53.28835070308541,56.82790913419297],
                    [53.2890588062653,56.8283444134614],
                    [53.289123179281724,56.82854440493726],
                    [53.28920649247791,56.828693056406216],
                    [53.29032229142806,56.829757694639845],
                    [53.293229631405964,56.83263526770077],
                    [53.294002107602175,56.83254116451087],
                    [53.299924425107136,56.83550530070302],
                    [53.31408648870568,56.83828102415202],
                    [53.31906466863733,56.85601254894626],
                    [53.317648462277546,56.86438153146598],
                    [53.315910390835874,56.87552158500073],
                    [53.3117690601169,56.88289944824338],
                    [53.30782084844693,56.88971209973567],
                    [53.30949454687218,56.89490297283665],
                    [53.31083177458623,56.89998320128224]
                ]
            ],
            2 => [
                'name' => '2 зона',
                'price' => (int) $config['price_2'],
                'free_from' => (int) $config['free_2'],
                'points' => [
                    [53.12733998895235,56.833168427869076],
                    [53.12814465165677,56.82744542806185],
                    [53.13238254190032,56.82247458732597],
                    [53.13713541627476,56.82597483411698],
                    [53.14260175824712,56.812945781572694],
                    [53.140420229874906,56.80467619520516],
                    [53.137037071864015,56.80271527233968],
                    [53.127009189680145,56.797003494500636],
                    [53.1393466868183,56.788126673196516],
                    [53.15028456909844,56.7839991156227],
                    [53.15521430318524,56.78326344963466],
                    [53.15580405700332,56.781886305397755],
                    [53.15282077624842,56.77988576118793],
                    [53.14434433143108,56.78193726017508],
                    [53.13683281752875,56.78476792054975],
                    [53.12923547293795,56.77591367287808],
                    [53.131290094818915,56.76735165383386],
                    [53.15370943934532,56.77166753888553],
                    [53.163597503354175,56.77494620580684],
                    [53.182172810115866,56.774519690309646],
                    [53.18529859295181,56.78031320012215],
                    [53.203748407878614,56.78106228465089],
                    [53.2060236259084,56.79104727024515],
                    [53.21620848474316,56.79872193256488],
                    [53.22623272660409,56.79709589444606],
                    [53.23491481009383,56.788558079279035],
                    [53.31636881202119,56.82986552275637],
                    [53.33854131542201,56.86437497399051],
                    [53.32919986326498,56.88420206617062],
                    [53.31299195602989,56.9030793624407],
                    [53.172851805468405,56.892751937811624],
                    [53.12128892541481,56.873492721357685],
                    [53.10918679833962,56.87288171665198],
                    [53.0812918245847,56.86681812661904],
                    [53.085669189696986,56.86369193681964],
                    [53.10154786706515,56.86192305531269],
                    [53.110216766601305,56.85263064072378],
                    [53.11656823754858,56.83648536593806],
                    [53.12733998895235,56.833168427869076]
                ]
            ],
            3 => [
                'name' => '3 зона',
                'price' => (int) $config['price_3'],
                'free_from' => (int) $config['free_3'],
                'points' => [
                    [53.131148244895904,56.755108205318315],
                    [53.16019044912133,56.76125024999562],
                    [53.2322638716839,56.77398943729537],
                    [53.27024516608197,56.79220228492462],
                    [53.30994307424956,56.80833469808612],
                    [53.37588348995516,56.84727545592253],
                    [53.327583259298486,56.892095085388874],
                    [53.32620996828281,56.90768801389857],
                    [53.32784075136391,56.91780582976752],
                    [53.31848520631997,56.921021357046754],
                    [53.16347466769928,56.907959362454186],
                    [53.06090683735377,56.88507933279781],
                    [53.04073646794577,56.86218523053403],
                    [53.091956088910145,56.84256857556918],
                    [53.10795286228293,56.82729801632515],
                    [53.117083180577644,56.818046641506626],
                    [53.1034793316861,56.7629210313698],
                    [53.131148244895904,56.755108205318315]
                ]
            ],
            4 => [
                'name' => '4 зона',
                'price' => (int) $config['price_4'],
                'free_from' => (int) $config['free_4'],
            ],
        ];
    }

    static function getDeliveryPriceByCoordinates($lat, $lon, $productSum = 0)
    {
        $zones = self::getZones();

        $zoneID = NULL;

        foreach ($zones as $key => $el) {
            if (@$el['points'] != NULL && self::isInPolygon($el['points'], $lat, $lon)) {
                $zoneID = $key;
                break;
            }
        }

        if ($zoneID == NULL) {
            $zoneID = 4;
        }

        $currentZone = $zones[$zoneID];

        if ($currentZone['free_from'] != False && $productSum >= $currentZone['free_from']) {
            return 0;
        }
        else {
            return $currentZone['price'];
        }
    }

    static function isInPolygon(
        $polygon,
        $longitude_x,
        $latitude_y
    ) {
        $vertices_x = array_map(function ($v) {
            return $v[0];
        }, $polygon);
        $vertices_y = array_map(function ($v) {
            return $v[1];
        }, $polygon);

        $points_polygon = count($vertices_x) - 1;

        $i = $j = $c = $point = 0;
        for ($i = 0, $j = $points_polygon; $i < $points_polygon; $j = $i++) {
            $point = $i;
            if ($point == $points_polygon) {
                $point = 0;
            }
            if ((($vertices_y[$point] > $latitude_y != ($vertices_y[$j] > $latitude_y)) &&
                 ($longitude_x < ($vertices_x[$j] - $vertices_x[$point]) * ($latitude_y - $vertices_y[$point]) / ($vertices_y[$j] - $vertices_y[$point]) + $vertices_x[$point]))) {
                $c = !$c;
            }
        }
        return $c;
    }

}
